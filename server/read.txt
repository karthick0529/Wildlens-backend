create a index.js file
    --npm init -y
    --npm install
    --import the mongoose module,
    --Connect to MongoDB using mongoose,
    --to connect mongoose need the MongoDB URI ,
    --the URI will put in the dotenv file to secure the password,
    --import and create the dotenv file ----- npm install dotenv,

then create the utils folder and create the config.js file,
    ---then import the dotenv package,
    ---Create all the necessary configuration variables,
    --using process.env.MONGODB_URI,like this,
    --and export the configuration variables,

then come to the index.js and import the config module,
    --and connect the mongoose and start the server,

to start the port and endpoints in app.js
then create the app.js file 
    ---and import the express js
    --create the express app
    --use the express json midlewares like-- app.use(express.json());
     --export the app module,

then create the Modules folder and create the users.js file,
    --import the mongoose,
    --and Here create the mongoose schemas,
    --and export the mongoose.module,
    --and store like objects key value pair,

then create the Controllers folder and create the usersController.js file,
    --import the user module,   
    --and Here create the usersController like objects key value pair,
    --define the methods 
    --get the user input from the req body,
    --check the username is already exists,
    --if the user exists, return a error message,
    --create a new user ,
    --before that hash the password using bcrypt,
    --to use bcrypt import the bcrypt package,
    --save the new user,
    --return a success message with saved user,    
and export the usersController,

then create the routes folder and create the usersroute.js file,
import the usersController and express js,
    --and create the express Router to create express router require express,
    --define the endpoints,
export the router.

the come to the app.js to define the endpoints 
    --define the endpoints
    --and to define the endpoints reuire the routes and import it,

create app.js file

getRazorpayOrder: async (req, res) => {
        try {
            const { amount } = req.body; // Amount in smallest currency unit (paise for INR)

            const options = {
                amount: amount * 100, // Convert amount to paise
                currency: "INR",
                receipt: `order_rcptid_${Date.now()}`,
            };

            const order = await razorpay.orders.create(options);
            res.status(200).json(order);
        } catch (error) {
            console.error("Error in getRazorpayOrder:", error); // Log the error
            res.status(400).send(error);
        }
    },

    const Booking = require("../modules/bookings");
const User = require('../modules/users');
const TourPackage = require('../modules/tourPackages');
const Razorpay = require("razorpay");
// const razorpayInstance = require('../utils/razorpay');
// const { RAZORPAY_KEY_ID } = require("../utils/razorpay");
const { CLIENT_SITE_URL } = require("../utils/config");
const crypto = require("crypto");

const razorpay = new Razorpay({
    key_id: process.env.RAZORPAY_KEY_ID,
    key_secret: process.env.RAZORPAY_KEY_SECRET
});

const bookingController = {

    // Method to get Razorpay payment order and initiate payment
    getRazorpayOrder: async (req, res) => {
        try {
            const tour = await TourPackage.findById(req.params.id);
            const user = await User.findById(req.userId);

            console.log("Tour ID:", req.params.id); // Log the tour ID

            const { guestSize, phone, bookAt, fullName, companion } = req.body;
            let companionFee = companion ? 20 : 0;
            const serviceFee = 10;
            const totalAmount = Number(tour.price) * Number(guestSize) + Number(serviceFee) + Number(companionFee);
            
            console.log(`Total Amount: ${totalAmount}`); // Log the total amount

            // Create a Razorpay order
            const options = {
                amount: totalAmount * 100, // Amount in paise
                currency: "INR",
                receipt: `receipt_${Date.now()}`,
                payment_capture: 1 // Automatically capture the payment
            };

            console.log("Creating Razorpay order with options:", options); // Log order creation options

            const order = await razorpay.orders.create(options);

            console.log("Razorpay Order created:", order); // Log the created order

            // Save booking details with the Razorpay order ID
            const newBooking = new Booking({
                userId: req.userId,
                userEmail: user.email,
                tourName: tour.name,
                fullName,
                guestSize,
                phone,
                bookAt,
                totalPrice: totalAmount,
                companion,
                session: order.id
            });

            await newBooking.save();

            res.status(200).json({
                message: "Booking initiated successfully",
                order,
                key_id: razorpay.key_id,
                bookingId: newBooking._id
            });

            console.log("New Booking:", newBooking); // Log the new booking
        } catch (error) {
            console.error("Error in getRazorpayOrder:", error); // Log the error
            res.status(500).json({ message: error.message });
        }
    },

    getUserBookings: async (req, res) => {
        try {
            // get the user id in req params
            const userId = req.userId

            //find the user bookings in database
            const user = await User.findById(userId)

            //if the user does not exists, return a error message
            if (!user) {
                return res.status(400).json({ message: "user not booked" })
            }
            const userBooking = await Booking.find({
                userId: userId
            }).select('-__v -phone')

            //return the success message
            res.status(200).json({ userBooking })
        } catch (error) {
            res.status(500).json({ message: error.message })
        }
    },
    
    getAllBookings: async (req, res) => {
        try {

            //find the user bookings in database
            const booking = await Booking.find().select("-__v")

            //if the booking does not exists, return a error message
            if (!booking) {
                return res.status(400).json({ message: "Booking not found" })
            }
            //return the success message
            res.status(200).json( {booking} )
        } catch (error) {
            res.status(500).json({ message: error.message })
        }
    },

    verifyRazorpayPayment: async (req, res) => {
        try {
            const { razorpay_order_id, razorpay_payment_id, razorpay_signature } = req.body;
    
            console.log("Razorpay Order ID:", razorpay_order_id);
            console.log("Razorpay Payment ID:", razorpay_payment_id);
            console.log("Razorpay Signature:", razorpay_signature);
    
            // Signature verification
            const generatedSignature = crypto.createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
                .update(`${razorpay_order_id}|${razorpay_payment_id}`)
                .digest('hex');
    
            console.log("Generated Signature:", generatedSignature);
    
            if (generatedSignature === razorpay_signature) {
                res.status(200).json({ message: "Payment verified successfully" });
            } else {
                res.status(400).json({ message: "Invalid signature" });
            }
        } catch (error) {
            console.error("Error in verifyRazorpayPayment:", error);
            res.status(500).json({ message: error.message });
        }
    }
       
    
};

module.exports = bookingController;
